<?xml version="1.0"?>
<tool id="idpassemble" name="idpAssemble" version="0.1.0">
    <description>Merge IDPicker databases from single files into a merged database, and filters the result at PSM/spectrum/peptide/protein/gene levels.</description>
    <requirements>
        <requirement type="package" version="3.0.8738">bumbershoot</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" level="fatal" description="Job Failed" />
        <regex match="^Could not find the default configuration file.*$"
            source="both"
            level="warning" />
    </stdio>
    <command>
        idpAssemble
            -MaxFDRScore $max_fdr_score
            -MinDistinctPeptides $filter_at_gene_level_condition.min_distinct_peptides
            -MinSpectra $filter_at_gene_level_condition.min_spectra
            -MinAdditionalPeptides $filter_at_gene_level_condition.min_additional_peptides
            -MinSpectraPerDistinctMatch $min_spectra_per_distinct_match
            -MinSpectraPerDistinctPeptide $min_spectra_per_distinct_peptide
            -MaxProteinGroupsPerPeptide $max_protein_groups_per_peptide
            #if $filter_at_gene_level_condition.filter_at_gene_level
            -FilterAtGeneLevel 1
            #end if
            -SummarizeSources 1
            #if len($input) > 1
                -MergedOutputFilepath output
                #for $i in $input
                    '${i.file_name}'
                #end for
            #else
                $input
                ;
                cp $input output
            #end if
    </command>
    <inputs>
        <param name="input" type="data" format="idpdb" label="Input File(s)" multiple="true"/>
        <param name="max_fdr_score" type="float" label="Max FDR Score" value="0.05" />
        <conditional name="filter_at_gene_level_condition">
            <param name="filter_at_gene_level" type="boolean" truevalue="1" falsevalue="0" label="Filter at Gene Level" help="Apply filters at the gene level (i.e. 'min distinct peptides per gene group' instead of 'min distinct peptides per protein group')"/>
            <when value="1">
                <param name="min_distinct_peptides" type="integer" label="Min Distinct Peptides per Gene Group" value="2" />
                <param name="min_spectra1" type="integer" label="Min Filtered Spectra per Gene Group" value="2" />
                <param name="min_additional_peptides" type="integer" label="Min Additional Peptides per Gene Group" value="1" />
            </when>
            <when value="0">
                <param name="min_distinct_peptides" type="integer" label="Min Distinct Peptides per Protein Group" value="2" />
                <param name="min_spectra" type="integer" label="Min Filtered Spectra per Protein Group" value="2" />
                <param name="min_additional_peptides" type="integer" label="Min Additional Peptides per Protein Group" value="1" />
            </when>
        </conditional>
        <param name="min_spectra_per_distinct_match" type="integer" label="Min Filtered Spectra per Distinct Match" value="1" />
        <param name="min_spectra_per_distinct_peptide" type="integer" label="Min Filtered Spectra per Distinct Peptide" value="1" />
        <param name="max_protein_groups_per_peptide" type="integer" label="Max Protein Groups per Distinct Peptide" value="10" />
        <!--<conditional name="advanced_options">
            <param name="use_advanced_options" type="boolean" truevalue="true" falsevalue="false" label="Set Advanced Options" />
            <when value="false" />
            <when value="true">
            </when>
        </conditional>-->
    </inputs>
    <outputs>
        <data format="idpdb" name="output" from_work_dir="output" />
    </outputs>
    <help>
<![CDATA[
**What it does**

Merges and filters one or more IDPicker 3 idpDB files into a combined idpDB file. Protein assembly (e.g. parsimony) is conducted on the combined set of proteins.

------

**Citation**

For the underlying tool, please cite `Ma Z-Q, Dasari S, Chambers MC, et al. IDPicker 2.0: Improved Protein Assembly with High Discrimination Peptide Identification Filtering. Journal of proteome research. 2009;8(8):3872-3881. doi:10.1021/pr900360j`

If you use this tool in Galaxy, please cite `Chilton J, Chambers MC, et al. https://github.com/galaxyproteomics/tools-galaxyp/tree/master/tools/idpassemble`
]]>
    </help>
    <citations>
        <citation type="doi">10.1021/pr900360j</citation>
    </citations>
</tool>
