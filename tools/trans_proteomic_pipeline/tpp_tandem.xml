<tool id="tpp_tandem" name="TPP tandem" version="@WRAPPER_VERSION@.0">
    <description>search</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="stdio" />
    <command><![CDATA[
        ## ln default params to working dir
        mkdir outputs &&
        ln -s "\$TPP_ROOT_PATH/bin/${default_params}" "${default_params}" &&
        tandem $input_params &&
        #if $output_type == 'tandem':
          cat $output_file > $output
        #else
          Tandem2XML $output_file $output
        #end if
    ]]></command>
    <configfiles>
        <configfile name="taxonomy_params"><![CDATA[#slurp
<?xml version="1.0"?>
<bioml label="x! taxon-to-file matching list">
    <taxon label="all">
        <file format="peptide" URL="/home/mscls/galaxyp2014/tmp/dia_umpire/UPS_PlusRev.fasta" />
    </taxon>
</bioml>
        ]]>
        </configfile>
        <configfile name="tandem_params"><![CDATA[#slurp
<?xml version="1.0" encoding="UTF-8"?>
<bioml>
    <note> FILE LOCATIONS. Replace them with your input (.mzXML) file and output file -- these are REQUIRED. Optionally a log file and a sequence output file of all protein sequences identified in the first-pass can be specified. Use of FULL path (not relative) paths is recommended. </note>
    <note> DEFAULT PARAMETERS. The value of "isb_default_input_kscore.xml" is recommended.
Change to "isb_default_input_native.xml" for native X!Tandem scoring.</note>
        <note type="input" label="list path, default parameters">/home/mscls/galaxyp2014/tmp/dia_umpire/isb_default_input_native.xml</note>

<note> FILE LOCATIONS. Replace them with your input (.mzXML) file and output file -- these are REQUIRED.
Optionally a log file and a sequence output file of all protein sequences identified in the first-pass can be specified.
Use of FULL path (not relative) paths is recommended. </note>
        <note type="input" label="spectrum, path">/home/mscls/galaxyp2014/tmp/dia_umpire/NAME.mzXML</note>
        <note type="input" label="output, path">/home/mscls/galaxyp2014/tmp/dia_umpire/NAME.tandem</note>
        <note type="input" label="output, log path">/home/mscls/galaxyp2014/tmp/dia_umpire/NAME.log</note>
        <note type="input" label="output, sequence path">/home/mscls/galaxyp2014/tmp/dia_umpire/NAME.bioml</note>
<note> TAXONOMY FILE. This is a file containing references to the sequence databases. Point it to your own taxonomy.xml if needed.</note>
        <note type="input" label="list path, taxonomy information">/home/mscls/galaxyp2014/tmp/dia_umpire/taxonomy.xml</note>
        <note type="input" label="protein, taxon">all</note>

<note> PROTEIN SEQUENCE DATABASE. This refers to identifiers in the taxomony.xml, not the .fasta files themselves!
Make sure the database you want is present as an entry in the taxonomy.xml referenced above. This is REQUIRED. </note>
    <note type="input" label="spectrum, use conditioning">yes</note>
    <note type="input" label="output,maximum valid expectation value">50</note>
    <note type="input" label="spectrum, threads">4</note>

    <note> PRECURSOR MASS TOLERANCES. In the example below, a 10ppm (monoisotopic mass) window is searched for peptide candidates. </note>
    <note type="input" label="spectrum, parent monoisotopic mass error minus">30.0</note>
    <note type="input" label="spectrum, parent monoisotopic mass error plus">30.0</note>
    <note type="input" label="spectrum, parent monoisotopic mass error units">ppm</note>
    <note>The value for this parameter may be 'Daltons' or 'ppm': all other values are ignored</note>
    <note type="input" label="spectrum, parent monoisotopic mass isotope error">no</note>
    <note type="input" label="spectrum, minimum peaks">3</note>
    <note type="input" label="spectrum, total peaks">140</note>"
    <note type="input" label="spectrum, fragment monoisotopic mass error">40.0</note>
    <note type="input" label="spectrum, fragment monoisotopic mass error units">ppm</note>
    <note>The value for this parameter may be 'Daltons' or 'ppm': all other values are ignored</note>
    <note>This allows peptide candidates in windows around -1 Da and -2 Da from the acquired mass to be considered. Only applicable when the minus/plus window above is set to less than 0.5 Da. Good for accurate-mass instruments for which the reported precursor mass is not corrected to the monoisotopic mass. </note>


    <note> MODIFICATIONS. In the example below, there is a static (carbamidomethyl) modification on C, and variable modifications on M (oxidation). Multiple modifications can be separated by commas, as in "80.0@S,80.0@T". Peptide terminal modifications can be specified with the symbol '[' for N-terminus and ']' for C-terminus, such as 42.0@[ .  </note>
    <note type="input" label="residue, potential modification mass">15.994915@M,57.021464@C</note>
    <note> Add labeling modification by replacing this line</note>
    <note type="input" label="residue, modification mass"></note>

    <note type="input" label="residue, potential modification motif"></note>
    <note> You can specify a variable modification only when present in a motif. For instance, 0.998@N!{P}[ST] is a deamidation modification on N only if it is present in an N[any but P][S or T] motif (N-glycosite). </note>
    <note type="input" label="protein, N-terminal residue modification mass"></note>
    <note type="input" label="protein, C-terminal residue modification mass"></note>
    <note> These are *static* modifications on the PROTEINS' N or C-termini. </note>

    <note> SEMI-TRYPTICS AND MISSED CLEAVAGES. In the example below, semitryptic peptides are allowed, and up to 2 missed cleavages are allowed. </note>
    <note type="input" label="protein, cleavage semi">no</note>
    <note type="input" label="scoring, maximum missed cleavage sites">1</note>
    <note type="input" label="scoring, minimum ion count">3</note>

    <note> REFINEMENT. Do not use unless you know what you are doing. Set "refine" to "yes" and specify what you want to search in the refinement. For non-confusing results, repeat the same modifications you set above for the first-pass here.</note>
    <note type="input" label="refine">no</note>
    <note type="input" label="refine, maximum valid expectation value">10</note>
    <note type="input" label="refine, potential modification mass">15.994915@M</note>
    <note type="input" label="refine, potential modification motif"></note>
    <note type="input" label="refine, cleavage semi">no</note>
    <note type="input" label="refine, unanticipated cleavage">no</note>
    <note type="input" label="refine, potential N-terminus modifications"></note>
    <note type="input" label="refine, potential C-terminus modifications"></note>
    <note type="input" label="refine, point mutations">no</note>
    <note type="input" label="refine, use potential modifications for full refinement">no</note>

</bioml>
        ]]>
        </configfile>

        <configfile name="input_params"><![CDATA[#slurp
<?xml version="1.0"?>
<bioml>
    <note type="input" label="list path, default parameters">$default_params</note>
    <note type="input" label="list path, taxonomy information">$taxonomy_params</note>
    <note type="input" label="protein, taxon">all</note>
    <note type="input" label="spectrum, path">$input_file</note>
    <note type="input" label="output, path">$output_file</note>
</bioml>
        ]]>
        </configfile>
    </configfiles>
    <inputs>
	<param name="output_file" type="hidden" value="outputs/output.tandem" help="A file with MS/MS data"/>
	<param name="input_file" type="data" format="mzxml" multiple="false" label="MSMS File" help="A file with MS/MS data"/>
        <conditional name="database">
            <param name="source_select" type="select" label="Database source">
                <option value="built_in">Built-In</option>
                <option value="input_ref" selected="true">Your Upload File</option>
            </param>
            <when value="built_in">
                <param name="dbkey" type="select" format="text" >
                    <label>Database</label>
                    <options from_file="pepxml_databases.loc">
                        <column name="name" index="0" />
                        <column name="value" index="2" />
                    </options>
                </param>
            </when>
            <when value="input_ref">
                <param name="fasta_file" type="data" format="fasta" label="Uploaded FASTA file" />
            </when>
        </conditional>
        <param name="output_type" type="select" label="Output Type">
            <option value="pep.xml" selected="true">pep.xml</option>
            <option value="tandem">tandem (bioml)</option>
        </param>
        <param name="default_params" type="select" label="Default Params">
            <option value="isb_default_input_native.xml" selected="true">isb_default_input_native.xml</option>
            <option value="isb_default_input_kscore.xml" selected="true">isb_default_input_kscore.xml</option>
        </param>
    </inputs>
    <outputs>
        <data name="output" format="pepxml" label="${input_file.name.rsplit('.',1)[0]}.${output_type}" >
            <change_format>
                <when input="output_type" value="tandem" format="tandem" />
            </change_format>
        </data>
    </outputs>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
    <expand macro="citations" />
</tool>
