var RequestObject=function(){"use strict";this.customSQL="",this.tableName="",this.limit=1e3,this.offset=0,this.draw=0,this.callBackFn=null,this.orderColumn=null,this.orderDirection=null,this.needCount=!1,this.actualRecordCount=0,this.makeNameArray=function(a){var b=[];return a.map(function(a){var c={};c.data=a.trim().split(".")[1],c.name=a.trim(),c.title=a.trim(),b.push(c)}),b}};!function(){"use strict";RequestObject.prototype.setFullDataCount=function(a){this.actualRecordCount=a.data[1][0]},RequestObject.prototype.generateColumnNames=function(){var a=[],b=null;if(this.customSQL.length>0){var c=this.customSQL.slice(this.customSQL.indexOf("SELECT")+6,this.customSQL.indexOf("FROM"));b=c.split(",")}else b=DataManager.tableColumns[this.tableName].map(function(a){return a.indexOf(":")>-1||a.indexOf(" ")>-1?this.tableName+'."'+a+'"':this.tableName+"."+a},this);return a=this.makeNameArray(b)},RequestObject.prototype.generateSQL=function(a){var b;return b=this.customSQL.length>0?this.customSQL:"SELECT * FROM "+this.tableName,this.orderColumn&&(b+=this.orderColumn.indexOf("Score")>-1?" ORDER BY CAST("+this.orderColumn+" AS REAL) "+this.orderDirection:" ORDER BY "+this.orderColumn+" "+this.orderDirection),this.limit>0&&(b+=" LIMIT "+this.limit+" OFFSET "+this.offset),a&&(b="SELECT COUNT(*) FROM ("+this.generateSQL().slice(0,this.generateSQL().indexOf("ORDER"))+")"),b}}();var ResponseObject=function(){this.draw=0,this.recordsTotal=0,this.recordsFiltered=0,this.data=[],this.error=null},ConfigurationObject=function(){this.href="",this.tableRowCount={},this.tableColumns={},this.dataSetID=""},DataManager=function(a){"use strict";return a.generateResponseObject=function(a,b){var c=[],d=[],e=new ResponseObject;return b.generateColumnNames().map(function(a){c.push(a.data)}),a.data.splice(0,1),a.data.map(function(a){var b={};c.map(function(c,d){b[c]=a[d]}),d.push(b)}),e.draw=parseInt(b.draw),DataManager.tableRowCount[b.tableName]?(e.recordsTotal=DataManager.tableRowCount[b.tableName],e.recordsFiltered=e.recordsTotal):(e.recordsTotal=b.actualRecordCount,e.recordsFiltered=b.actualRecordCount),e.data=d,e},a.executeSQL=function(b,c){$.get(c,function(c){b.callBackFn(a.generateResponseObject(c,b))}).error(function(a,b,d){var e=$("<div>",{id:"ajax_error",title:"Query Error"}),f=$("<p>",{text:a.responseText});e.dialog({minWidth:200,height:200}),e.append(f),setTimeout(function(){e.dialog("close")},5e3),console.log("ERROR: failed in returning url: "+c),console.log("ERROR: "+a.responseText)})},a.getDataCount=function(b){$.get(DataManager.urlString+b.generateSQL(!0),function(c){b.setFullDataCount(c),a.getData(b)})},a.getData=function(b){var c=DataManager.urlString;c+=b.generateSQL(),a.executeSQL(b,c)},{configure:function(a){DataManager.hrefValue=a.href,DataManager.dataID=a.dataSetID,DataManager.tableRowCount=a.tableRowCount,DataManager.tableColumns=a.tableColumns,DataManager.urlString=a.href+"/api/datasets/"+a.dataSetID+"?data_type=raw_data&provider=sqlite-table&headers=True&query="},ajaxDataProvider:function(b,c,d,e){var f=d;f.callBackFn=e,f.limit=b.length,f.offset=b.start,f.draw=b.draw,b.order.length>0&&(f.orderColumn=b.columns[b.order[0].column].name,f.orderDirection=b.order[0].dir),f.needCount?a.getDataCount(f):a.getData(f)}}}(DataManager||{}),PrettySQL=function(a){var b={SELECT:'<font size="4" color="#6A5ACD"><tt>SELECT</tt></font>',FROM:'<font size="4" color="#6A5ACD"><tt>FROM</tt></font>',WHERE:'<font size="4" color="#6A5ACD"><tt>WHERE</tt></font>',"ORDER BY":'<font size="4" color="#6A5ACD"><tt>ORDER BY</tt></font>',ASC:'<font size="4" color="#6A5ACD"><tt>ASC</tt></font>',DESC:'<font size="4" color="#6A5ACD"><tt>DESC</tt></font>',IN:'<font size="4" color="#6A5ACD"><tt>IN</tt></font>',AND:'<font size="4" color="#6A5ACD"><tt>AND</tt></font>'};return a.formatSQL=function(a){return Object.keys(b).map(function(c){var d=new RegExp("\\b"+c+"\\b","i"),e=b[c];a=a.replace(d,e)}),a},a}(PrettySQL||{}),SavedQueryManager=function(a){var b="<NEWQUERY>";return a.getExistingQueries=function(a){var c=[];return localStorage[a]&&(c=localStorage[a].split(b)),c},a.resetQueries=function(c,d){var e="";d.length>0?(d.map(function(a){e+=a+b}),e=e.slice(0,e.lastIndexOf("<NEWQUERY>"))):e="",localStorage[c]=e,a.initQueryOptionMenu()},a.isDropInList=function(a){var b=!1,c={top:0,bottom:0,left:0,right:0},d=!1,e=!1;return c.top=$("#sqlContent").offset().top,c.bottom=$("#sqlContent").offset().top+$("#sqlContent").height(),c.left=$("#sqlContent").offset().left,c.right=$("#sqlContent").offset().left+$("#sqlContent").width(),a.position.top>=c.top&&a.position.top<=c.bottom&&(d=!0),a.position.left>=c.left&&a.position.left<=c.right&&(e=!0),b=d&e},a.dropBehavior=function(b,c){var d=c.target.textContent,e=DataManager.dataID,f=a.getExistingQueries(e);a.isDropInList(b)||f.length>0&&(f.map(function(a,b){a===d&&f.splice(b,1)}),a.resetQueries(e,f))},a.queryClick=function(a){$("#sqlText").val(a.target.textContent)},a.generateQueryElement=function(b){var c=$("<li/>").attr("class","sQuery").attr("style","cursor: pointer").on("click",function(b){a.queryClick(b)}).draggable({helper:"clone",stop:function(b,c){a.dropBehavior(c,b)}}).html(PrettySQL.formatSQL(b));return c},a.initQueryOptionMenu=function(){"use strict";var c,d=DataManager.dataID;$("#queryList").empty(),localStorage[d]&&(c=localStorage[d].split(b)),c&&c.map(function(b){b.length>0&&$("#queryList").append(a.generateQueryElement(b))})},a.populateQueryOptionMenu=function(b){$("#queryList").append(a.generateQueryElement(b))},a.standardizeQuery=function(a){var b=["select","from","where","in","order by","asc","desc"];return b.map(function(b){var c=new RegExp("\\b"+b+"\\b","i");a=a.replace(c,b.toUpperCase())}),a},a.saveQuery=function(c){"use strict";var d,e=DataManager.dataID;localStorage[e]?(d=localStorage[e],d+=b+a.standardizeQuery($("#"+c).val())):d=a.standardizeQuery($("#"+c).val()),localStorage[e]=d,a.populateQueryOptionMenu($("#"+c).val())},a}(SavedQueryManager||{}),TableSchemaWidget=function(a){"use strict";return a.buildElement=function(a){var b,c,d,e;return b=$("<ul/>",{id:"chemaContainer"}),Object.keys(a).map(function(f){c=$("<li/>",{name:f,text:f,style:"cursor: pointer","class":"tableName"}),c.on("click",function(a){"none"===a.target.firstElementChild.style.display?a.target.firstElementChild.style.display="block":a.target.firstElementChild.style.display="none"}),c.draggable({helper:"clone"}),e=$("<ul/>",{id:"ul_"+f,style:"display: none",name:f}),a[f].map(function(a){d=$("<li/>",{id:a,name:a,text:a}),d.draggable({helper:"clone"}),e.append(d)}),c.append(e),b.append(c)}),b},{generateSchemaWidget:function(b){return a.buildElement(b)}}}(TableSchemaWidget||{}),SQLEditorPopulator=function(a){"use strict";return a.escapeDBFieldNames=function(a){var b=[";"," ",":"],c=!1,d=a;return b.map(function(b){a.indexOf(b)>-1&&(c=!0)}),c&&(d='"'+a+'"'),d},a.droppedTableName=function(b){var c="SELECT ",d=b.attr("name");return b.children().children().each(function(b){c+=d+"."+a.escapeDBFieldNames(this.id)+", "}),c=c.slice(0,c.lastIndexOf(","))+" FROM "+d},a.dropBehavior=function(b,c){var d,e,f,g,h,i,j=this.value;c.draggable.hasClass("tableName")?this.value=a.droppedTableName(c.draggable):0===j.length?(this.value="SELECT "+c.draggable[0].parentNode.id.replace("ul_","")+'."'+c.draggable.text()+'" ',this.value+=" FROM "+c.draggable[0].parentNode.id.replace("ul_","")):(e=j.toLocaleUpperCase().indexOf(" SELECT "),g=j.toLocaleUpperCase().indexOf(" FROM "),i=j.toLocaleUpperCase().indexOf(" WHERE "),d=j.slice(e+8,g),f=j.slice(g+6,i>-1?i:j.length),h=i>-1?j.slice(i+7,j.length):"",d+=", "+c.draggable[0].parentNode.id.replace("ul_","")+'."'+c.draggable.text()+'" ',-1===f.indexOf(c.draggable[0].parentNode.id.replace("ul_",""))&&(f+=", "+c.draggable[0].parentNode.id.replace("ul_","")),this.value="SELECT "+d+"FROM "+f+" WHERE "+h)},a}(SQLEditorPopulator||{}),SQLDataViewer=function(a){"use strict";return a.createTable=function(a){$.fn.DataTable.isDataTable("#data_table")&&($("#dataGrid").empty(),$("#copyData").hide()),$("#copyData").show(),$("#dataGrid").html('<table cellpadding="0" cellspacing="0" border="0" class="display" id="data_table"></table>'),$("#data_table").dataTable({dom:'C<"top"i>tr<"bottom"flp><"clear">',scrollX:"100%",processing:!0,serverSide:!0,ajax:function(b,c,d){DataManager.ajaxDataProvider(b,d,a,c)},columns:a.generateColumnNames()})},a.createTableForCustomSQL=function(b){var c=new RequestObject;c.customSQL=b,c.needCount=!0,a.createTable(c)},a.createTableForSelection=function(b){var c=new RequestObject;c.tableName=b,c.sqlEditorBox=$("#sqlText"),a.createTable(c)},a.configurePageElements=function(){$("#copyData").hide(),$("#copyData").on("click",function(){var a,b=$("#data_table").DataTable(),c="";b.data().map(function(b){var d="";Object.keys(b).map(function(a){d+=b[a]+","}),a=Object.keys(b).toString(),c+="\n"+d.slice(0,-1)}),c=a+c,window.prompt("Copy to clipboard: Cmd+C, Enter",c)}),$("#tableSchema").append(TableSchemaWidget.generateSchemaWidget(DataManager.tableColumns)),$("#sqlText").droppable({accept:".tableName",drop:SQLEditorPopulator.dropBehavior}),$("#savedQueries").on("click",function(){$("#sqlContent").slideToggle(500,function(){})}),SavedQueryManager.initQueryOptionMenu()},a.produceVisualization=function(b){var c,d,e=new ConfigurationObject,f=$("#availableTables"),g=Object.keys(b.tableRowCount);for($("#mainTitle").text("SQLite Data Type Viewer - "+b.dataName),e.dataSetID=b.datasetID,e.href=b.href,e.tableColumns=b.tableColumns,e.tableRowCount=b.tableRowCount,DataManager.configure(e),c=0;c<g.length;c+=1)d=$("<option/>",{value:g[c],text:g[c]}),f.append(d);f.on("change",function(b){a.createTableForSelection(b.target.value)}),$("#fireSQL").on("click",function(){a.createTableForCustomSQL($("#sqlText")[0].value)}),$("#clearSQL").on("click",function(){$("#sqlText").val("")}),$("#saveSQL").on("click",function(){SavedQueryManager.saveQuery("sqlText")}),a.configurePageElements()},a}(SQLDataViewer||{});